# Deploy Vercel projects from monorepo
deploy-vercel:
  stage: deploy
  image: $ARTIFACTORY_DOCKER_REPO/node:20-alpine
  rules:
    # Only run on branches starting with "proj-" and when VERCEL_TOKEN is available
    - if: '$CI_COMMIT_BRANCH =~ /^proj-.*/ && $VERCEL_TOKEN'
  before_script:
    - chmod +x .gitlab-ci/scripts/prepare-vercel-deployment.sh
    - ./.gitlab-ci/scripts/prepare-vercel-deployment.sh "$CI_COMMIT_BRANCH"

  script:
    - echo "ðŸš€ Starting deployment..."
    - echo ""
    - chmod +x .shared/scripts/deploy-vercel.sh
    - ./.shared/scripts/deploy-vercel.sh "$CI_COMMIT_BRANCH"

  environment:
    name: vercel-preview/$PROJECT_NAME
    url: https://$PROJECT_NAME-git-$CI_COMMIT_BRANCH-grammarly-0ad4c188.vercel.app
    on_stop: stop-vercel-preview
    auto_stop_in: 30 days

  artifacts:
    reports:
      dotenv: deploy.env
    expire_in: 1 day

# Optional: Stop preview environment (manual action)
stop-vercel-preview:
  stage: deploy
  image: $ARTIFACTORY_DOCKER_REPO/node:20-alpine
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^proj-.*/'
      when: manual
  script:
    - echo "ðŸ›‘ Stopping Vercel preview environment"
    - echo "Note - Preview deployments are automatically cleaned up by Vercel"
    - echo "This is a placeholder for manual cleanup if needed"
  environment:
    name: vercel-preview/$PROJECT_NAME
    action: stop
