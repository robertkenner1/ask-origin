# Reusable template for Vercel project configuration via REST API
# Can be used standalone or included in deployment workflows
#
# Required environment variables:
#   VERCEL_TOKEN       - Vercel API authentication token
#   PROJECT_NAME       - Vercel project name
#
# Optional environment variables:
#   VERCEL_ORG_ID            - Team/organization ID (for team projects)
#   VERCEL_SSO_PROTECTION    - Set to "all" to require Vercel login for all deployments
#
# API Documentation: https://vercel.com/docs/rest-api

.configure_vercel_project:
  script:
    - |
      echo "=================================================="
      echo "‚öôÔ∏è  Vercel Project Configuration (API)"
      echo "=================================================="
      echo ""

      # Build API URL with optional team ID
      API_URL="https://api.vercel.com/v9/projects/$PROJECT_NAME"
      if [ -n "$VERCEL_ORG_ID" ]; then
        API_URL="$API_URL?teamId=$VERCEL_ORG_ID"
      fi

      echo "Project: $PROJECT_NAME"
      [ -n "$VERCEL_ORG_ID" ] && echo "Team ID: $VERCEL_ORG_ID"
      echo ""

      # Configure SSO Protection
      if [ "$VERCEL_SSO_PROTECTION" = "all" ]; then
        echo "üîí Configuring SSO Protection..."
        echo "   Deployment type: all"
        echo "   (Requires Vercel login + team access for ALL deployments)"
        echo ""

        HTTP_CODE=$(curl -X PATCH "$API_URL" \
          -H "Authorization: Bearer $VERCEL_TOKEN" \
          -H "Content-Type: application/json" \
          -d '{"ssoProtection": {"deploymentType": "all"}}' \
          --silent --show-error \
          --write-out "%{http_code}" \
          --output /tmp/vercel-sso-response.json)

        if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
          echo "‚úÖ SSO Protection enabled successfully (HTTP $HTTP_CODE)"
        else
          echo "‚ùå SSO Protection API failed (HTTP $HTTP_CODE)"
          echo ""
          echo "Response:"
          cat /tmp/vercel-sso-response.json 2>/dev/null || echo "(no response body)"
          echo ""
          exit 1
        fi
        echo ""
      else
        echo "‚ÑπÔ∏è  SSO Protection not requested"
        echo "   Set VERCEL_SSO_PROTECTION=all to enable"
        echo ""
      fi

      # Placeholder for future API configurations:
      # - Environment variables: POST /v9/projects/{id}/env
      # - Custom domains: POST /v10/projects/{id}/domains
      # - Build settings: PATCH /v9/projects/{id}
      # - Protection bypass: PATCH /v9/projects/{id}/protection-bypass

      echo "‚úÖ Project configuration complete"
      echo "=================================================="
      echo ""
