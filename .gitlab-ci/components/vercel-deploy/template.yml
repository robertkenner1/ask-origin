---
# Universal Vercel Deployment Component
# Pure YAML - no external script dependencies
# Can be moved to central repository for organization-wide use

spec:
  inputs:
    # Required Inputs
    vercel-token:
      description: "Vercel authentication token (required). Set as GitLab CI/CD variable."
      default: ""

    project-name:
      description: "Vercel project name (required). Must match your Vercel project."
      default: ""

    # Team/Organization Configuration
    team-slug:
      description: "Vercel team or organization slug. Leave empty for personal projects."
      default: ""

    # Path Configuration
    project-path:
      description: "Path to project directory relative to repository root. Use '.' for root, or 'projects/my-app' for monorepo."
      default: "."

    # Environment Configuration
    environment:
      description: "Deployment environment: 'preview' (default) or 'production'. Production deployments use --prod flag."
      default: "preview"

    # Build Configuration
    prebuild:
      description: "Run local prebuild before deployment. Set to true for projects with private npm packages or Artifactory dependencies."
      default: true
      type: boolean

    # CI Configuration
    stage:
      description: "GitLab CI stage for the deployment job."
      default: "deploy"

    # Version Configuration
    node-version:
      description: "Node.js version to use for deployment. Supports any valid Node Docker tag."
      default: "20"

    vercel-cli-version:
      description: "Vercel CLI version to install. Use 'latest' or specific version like '33.0.0'."
      default: "latest"

    # Job Execution Rules
    rules:
      description: "GitLab CI rules for when to run the deployment job. Define conditions like branch patterns and file changes."
      type: array
      default: []

    # Project Configuration
    sso-protection:
      description: "Enable SSO protection for deployments. Set to 'all' to require Vercel login + team access for all deployments (preview and production)."
      default: ""

    shared-env-vars:
      description: "Comma-separated list of shared environment variable keys to link to this project (e.g., 'CLAUDE_API_KEY,DATABASE_URL'). These must already exist as shared env vars in your Vercel team."
      default: ""

---
# Main deployment job
vercel-deploy-$[[ inputs.project-name ]]:
  stage: $[[ inputs.stage ]]
  image: node:$[[ inputs.node-version ]]-alpine
  rules: $[[ inputs.rules ]]

  before_script:
    - |
      echo "=================================================="
      echo "‚öôÔ∏è  Setting up Vercel Deployment Environment"
      echo "=================================================="
      echo ""

      # Install required system packages
      echo "üì¶ Installing system dependencies..."
      apk add --no-cache bash curl jq git sed
      echo "‚úÖ System dependencies installed"
      echo ""

      # Configure Artifactory for npm (if credentials available)
      if [ -n "$ARTIFACTORY_USER" ] && [ -n "$ARTIFACTORY_PASSWORD" ]; then
        echo "üîê Configuring Artifactory authentication..."
        ARTIFACTORY_NPM_URL="https://artifactory.grammarly.io/artifactory/api/npm"

        echo "registry=${ARTIFACTORY_NPM_URL}/common-npm/" > ~/.npmrc
        curl -u $ARTIFACTORY_USER:$ARTIFACTORY_PASSWORD $ARTIFACTORY_NPM_URL/auth >> ~/.npmrc
        sed -i 's/_auth/\/\/artifactory.grammarly.io\/artifactory\/api\/npm\/common-npm\/:_auth/g' ~/.npmrc

        echo "‚úÖ Artifactory authentication configured"
      else
        echo "‚ÑπÔ∏è  Artifactory credentials not provided (ARTIFACTORY_USER/ARTIFACTORY_PASSWORD)"
        echo "   Using default npm registry for public packages"
      fi
      echo ""
      echo "Installing pnpm for vercel templates"
      npm install --global pnpm@latest 
      echo "‚úÖ pnpm installed: $(pnpm --version)"
      echo ""

      # Install Vercel CLI
      echo "üì¶ Installing Vercel CLI (version: $[[ inputs.vercel-cli-version ]])..."
      npm install --global vercel@$[[ inputs.vercel-cli-version ]]
      echo "‚úÖ Vercel CLI installed: $(vercel --version)"
      echo ""

      # Export variables for use in script sections
      export VERCEL_TOKEN="$[[ inputs.vercel-token ]]"
      export PROJECT_NAME="$[[ inputs.project-name ]]"
      export TEAM_SLUG="$[[ inputs.team-slug ]]"
      export PROJECT_PATH="$[[ inputs.project-path ]]"
      export ENVIRONMENT="$[[ inputs.environment ]]"
      export PREBUILD="$[[ inputs.prebuild ]]"
      export VERCEL_SSO_PROTECTION="$[[ inputs.sso-protection ]]"
      export SHARED_ENV_VARS="$[[ inputs.shared-env-vars ]]"

      # Validation: Check required inputs
      echo "üîç Validating configuration..."

      if [ -z "$VERCEL_TOKEN" ]; then
        echo "‚ùå ERROR: vercel-token is required"
        echo ""
        echo "Please set VERCEL_TOKEN in GitLab CI/CD variables:"
        echo "  Settings ‚Üí CI/CD ‚Üí Variables ‚Üí Add Variable"
        echo "  Get token from: https://vercel.com/account/tokens"
        exit 1
      fi

      if [ -z "$PROJECT_NAME" ]; then
        echo "‚ùå ERROR: project-name is required"
        echo ""
        echo "Please specify the Vercel project name in component inputs:"
        echo "  inputs:"
        echo "    project-name: \"your-project-name\""
        exit 1
      fi

      # Validation: Check project directory exists
      if [ ! -d "$PROJECT_PATH" ]; then
        echo "‚ùå ERROR: Project directory does not exist: $PROJECT_PATH"
        echo ""
        echo "Please verify:"
        echo "  1. The project-path input is correct"
        echo "  2. The directory exists in your repository"
        echo ""
        echo "Current directory: $(pwd)"
        echo "Directory contents:"
        ls -la
        exit 1
      fi

      # Validation: Check package.json exists
      if [ ! -f "$PROJECT_PATH/package.json" ]; then
        echo "‚ùå ERROR: No package.json found in $PROJECT_PATH"
        echo ""
        echo "Vercel requires a Node.js project with package.json"
        echo "Directory contents of $PROJECT_PATH:"
        ls -la "$PROJECT_PATH"
        exit 1
      fi

      # Validation: Check environment value
      if [ "$ENVIRONMENT" != "preview" ] && [ "$ENVIRONMENT" != "production" ]; then
        echo "‚ùå ERROR: Invalid environment value: $ENVIRONMENT"
        echo ""
        echo "Allowed values: 'preview' or 'production'"
        exit 1
      fi

      echo "‚úÖ All validations passed"
      echo ""

      echo "Configuration:"
      echo "  ‚Ä¢ Project: $PROJECT_NAME"
      echo "  ‚Ä¢ Team: ${TEAM_SLUG:-<none>}"
      echo "  ‚Ä¢ Path: $PROJECT_PATH"
      echo "  ‚Ä¢ Environment: $ENVIRONMENT"
      echo "  ‚Ä¢ Prebuild: $PREBUILD"
      echo "  ‚Ä¢ Node: $[[ inputs.node-version ]]"
      echo "  ‚Ä¢ Vercel CLI: $[[ inputs.vercel-cli-version ]]"
      echo ""

  script:
    - |
      set -e

      echo "=================================================="
      echo "üöÄ Vercel Deployment"
      echo "=================================================="
      echo ""

      # Change to project directory
      echo "üìÅ Changing to project directory: $PROJECT_PATH"
      cd "$PROJECT_PATH"
      echo "‚úÖ In project directory"
      echo ""

      # Build team slug argument
      TEAM_ARG=""
      if [ -n "$TEAM_SLUG" ]; then
        TEAM_ARG="--scope $TEAM_SLUG"
      fi

      # Link Vercel project
      echo "üîó Linking Vercel project..."
      echo "   Project: $PROJECT_NAME"
      if [ -n "$TEAM_SLUG" ]; then
        echo "   Team: $TEAM_SLUG"
      fi

      vercel link --yes \
        --project "$PROJECT_NAME" \
        $TEAM_ARG \
        --token "$VERCEL_TOKEN"
      echo "‚úÖ Project linked successfully"
      echo ""

      # Extract project and org IDs from .vercel/project.json
      echo "üìã Extracting project configuration..."
      if [ -f ".vercel/project.json" ]; then
        export VERCEL_ORG_ID=$(cat .vercel/project.json | jq -r '.orgId')
        export VERCEL_PROJECT_ID=$(cat .vercel/project.json | jq -r '.projectId')
        echo "‚úÖ Extracted IDs from .vercel/project.json"
        echo "   Org ID: $VERCEL_ORG_ID"
        echo "   Project ID: $VERCEL_PROJECT_ID"
      else
        echo "‚ùå ERROR: .vercel/project.json not found after linking"
        echo "   This file should be created by 'vercel link' command"
        exit 1
      fi
      echo ""

      # Configure project settings via Vercel API (if requested)
      if [ "$VERCEL_SSO_PROTECTION" = "all" ] || [ -n "$SHARED_ENV_VARS" ]; then
        echo "=================================================="
        echo "‚öôÔ∏è  Vercel Project Configuration (API)"
        echo "=================================================="
        echo ""

        echo "Project: $PROJECT_NAME"
        echo "Project ID: $VERCEL_PROJECT_ID"
        [ -n "$VERCEL_ORG_ID" ] && echo "Team ID: $VERCEL_ORG_ID"
        echo ""

        # Configure SSO Protection
        if [ "$VERCEL_SSO_PROTECTION" = "all" ]; then
          # Build API URL with optional team ID
          API_URL="https://api.vercel.com/v9/projects/$PROJECT_NAME"
          if [ -n "$VERCEL_ORG_ID" ]; then
            API_URL="$API_URL?teamId=$VERCEL_ORG_ID"
          fi

          echo "üîí Configuring SSO Protection..."
          echo "   Deployment type: all"
          echo "   (Requires Vercel login + team access for ALL deployments)"
          echo ""

          HTTP_CODE=$(curl -X PATCH "$API_URL" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"ssoProtection": {"deploymentType": "all"}}' \
            --silent --show-error \
            --write-out "%{http_code}" \
            --output /tmp/vercel-sso-response.json)

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ SSO Protection enabled successfully (HTTP $HTTP_CODE)"
          else
            echo "‚ùå SSO Protection API failed (HTTP $HTTP_CODE)"
            echo ""
            echo "Response:"
            cat /tmp/vercel-sso-response.json 2>/dev/null || echo "(no response body)"
            echo ""
            exit 1
          fi
          echo ""
        fi

        # Link Shared Environment Variables
        if [ -n "$SHARED_ENV_VARS" ]; then
          echo "üîó Linking Shared Environment Variables..."
          echo "   Variables to link: $SHARED_ENV_VARS"
          echo ""

          # Build API URL for listing env vars
          ENV_API_URL="https://api.vercel.com/v1/env"
          if [ -n "$VERCEL_ORG_ID" ]; then
            ENV_API_URL="$ENV_API_URL?teamId=$VERCEL_ORG_ID"
          fi

          # Fetch all shared environment variables
          echo "üìã Fetching shared environment variables..."
          curl -X GET "$ENV_API_URL" \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            --silent --show-error \
            --output /tmp/vercel-env-list.json

          if [ ! -s /tmp/vercel-env-list.json ]; then
            echo "‚ùå Failed to fetch environment variables"
            exit 1
          fi

          # Check if response contains an error
          if jq -e '.error' /tmp/vercel-env-list.json > /dev/null 2>&1; then
            echo "‚ùå API Error:"
            jq -r '.error.message' /tmp/vercel-env-list.json
            exit 1
          fi

          # Check if data array exists and is not null
          if ! jq -e '.data' /tmp/vercel-env-list.json > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  No environment variables found in API response"
            echo ""
            echo "API Response structure:"
            jq '.' /tmp/vercel-env-list.json | head -20
            echo ""
            echo "This usually means:"
            echo "  1. No shared environment variables exist in the team"
            echo "  2. The API endpoint or response format has changed"
            echo "  3. The token lacks permissions to read env vars"
            echo ""
            exit 1
          fi

          echo "‚úÖ Fetched environment variables list"
          echo ""

          # Build updates JSON for PATCH request
          echo "üîç Matching requested variables with shared env vars..."
          UPDATES_JSON="{\"updates\":{}}"

          # Split comma-separated list and process each variable
          # Save to temp file for POSIX-compliant iteration
          echo "$SHARED_ENV_VARS" | tr ',' '\n' > /tmp/vercel-env-keys.txt

          while IFS= read -r VAR_KEY; do
            # Trim whitespace
            VAR_KEY=$(echo "$VAR_KEY" | xargs)

            if [ -z "$VAR_KEY" ]; then
              continue
            fi

            echo "   Looking for: $VAR_KEY"

            # Find the environment variable ID by key
            # Handle null .data array gracefully
            ENV_ID=$(jq -r --arg key "$VAR_KEY" '(.data // []) | .[] | select(.key == $key) | .id' /tmp/vercel-env-list.json 2>/dev/null || echo "")

            if [ -z "$ENV_ID" ] || [ "$ENV_ID" = "null" ]; then
              echo "   ‚ö†Ô∏è  Warning: Shared env var '$VAR_KEY' not found - skipping"
              continue
            fi

            echo "   ‚úÖ Found: $VAR_KEY (ID: $ENV_ID)"

            # Add to updates JSON
            UPDATES_JSON=$(echo "$UPDATES_JSON" | jq --arg id "$ENV_ID" --arg projectId "$VERCEL_PROJECT_ID" \
              '.updates[$id] = {"projectIdUpdates": {"link": [$projectId]}}')
          done < /tmp/vercel-env-keys.txt

          # Check if we have any updates to apply
          UPDATE_COUNT=$(echo "$UPDATES_JSON" | jq '.updates | length')

          if [ "$UPDATE_COUNT" -eq 0 ]; then
            echo ""
            echo "‚ö†Ô∏è  No valid shared environment variables found to link"
            echo ""
          else
            echo ""
            echo "üì§ Linking $UPDATE_COUNT environment variable(s) to project..."

            # Build PATCH API URL
            PATCH_API_URL="https://api.vercel.com/v1/env"
            if [ -n "$VERCEL_ORG_ID" ]; then
              PATCH_API_URL="$PATCH_API_URL?teamId=$VERCEL_ORG_ID"
            fi

            # Apply updates
            HTTP_CODE=$(curl -X PATCH "$PATCH_API_URL" \
              -H "Authorization: Bearer $VERCEL_TOKEN" \
              -H "Content-Type: application/json" \
              -d "$UPDATES_JSON" \
              --silent --show-error \
              --write-out "%{http_code}" \
              --output /tmp/vercel-env-patch-response.json)

            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "‚úÖ Environment variables linked successfully (HTTP $HTTP_CODE)"

              # Show results
              UPDATED_COUNT=$(jq '.updated | length' /tmp/vercel-env-patch-response.json 2>/dev/null || echo "0")
              FAILED_COUNT=$(jq '.failed | length' /tmp/vercel-env-patch-response.json 2>/dev/null || echo "0")

              echo "   Updated: $UPDATED_COUNT"
              if [ "$FAILED_COUNT" -gt 0 ]; then
                echo "   Failed: $FAILED_COUNT"
                echo ""
                echo "Failed variables:"
                jq -r '.failed[] | "   - \(.envId): \(.error.message)"' /tmp/vercel-env-patch-response.json 2>/dev/null
              fi
            else
              echo "‚ùå Environment variables linking failed (HTTP $HTTP_CODE)"
              echo ""
              echo "Response:"
              cat /tmp/vercel-env-patch-response.json 2>/dev/null || echo "(no response body)"
              echo ""
              exit 1
            fi
            echo ""
          fi
        fi

        echo "‚úÖ Project configuration complete"
        echo "=================================================="
        echo ""
      fi

      # Conditional build based on prebuild setting
      if [ "$PREBUILD" = "true" ]; then
        echo "üî® Building project locally..."
        if [ "$ENVIRONMENT" = "production" ]; then
          echo "   Mode: PRODUCTION build"
          vercel build --yes --prod --token "$VERCEL_TOKEN"
        else
          echo "   Mode: PREVIEW build"
          vercel build --yes --token "$VERCEL_TOKEN"
        fi
        echo "‚úÖ Build completed successfully"
        echo ""
      else
        echo "‚ÑπÔ∏è  Skipping local prebuild (prebuild: false)"
        echo ""
      fi

      # Deploy based on environment
      echo "üöÄ Deploying to Vercel ($ENVIRONMENT)..."

      if [ "$ENVIRONMENT" = "production" ]; then
        echo "   Mode: PRODUCTION deployment"
        if [ "$PREBUILD" = "true" ]; then
          DEPLOY_OUTPUT=$(vercel deploy --prebuilt --prod $TEAM_ARG --token "$VERCEL_TOKEN" 2>&1 | tee /dev/stderr)
        else
          DEPLOY_OUTPUT=$(vercel deploy --prod $TEAM_ARG --token "$VERCEL_TOKEN" 2>&1 | tee /dev/stderr)
        fi
      else
        echo "   Mode: PREVIEW deployment"
        if [ "$PREBUILD" = "true" ]; then
          DEPLOY_OUTPUT=$(vercel deploy --prebuilt $TEAM_ARG --token "$VERCEL_TOKEN" 2>&1 | tee /dev/stderr)
        else
          DEPLOY_OUTPUT=$(vercel deploy $TEAM_ARG --token "$VERCEL_TOKEN" 2>&1 | tee /dev/stderr)
        fi
      fi

      # Extract and display deployment URL
      echo ""
      echo "=================================================="
      DEPLOYMENT_URL=$(echo "$DEPLOY_OUTPUT" | grep -Eo 'https://[a-zA-Z0-9.-]+\.vercel\.app' | head -1)
      if [ -n "$DEPLOYMENT_URL" ]; then
        echo "‚úÖ Deployment successful!"
        if [ "$ENVIRONMENT" = "production" ]; then
          echo "üåê Production URL: $DEPLOYMENT_URL"
        else
          echo "üåê Preview URL: $DEPLOYMENT_URL"
        fi
      else
        echo "‚ö†Ô∏è  Deployment completed but URL extraction failed"
        echo "Check the output above for the deployment URL"
      fi
      echo "=================================================="

  retry:
    max: 1
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

  timeout: 30m
